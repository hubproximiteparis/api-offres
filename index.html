<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hub Emploi | Recherche Proximit√©</title>
    
    <style>
        :root {
            --primary: #004185;
            --accent: #e82332;
            --bg: #f4f7f9;
            --text: #2c3e50;
            --shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: var(--bg); 
            color: var(--text);
            margin: 0; 
            line-height: 1.6;
        }

        .container { 
            max-width: 550px; 
            margin: 20px auto; 
            background: white; 
            padding: 25px; 
            border-radius: 16px; 
            box-shadow: var(--shadow); 
        }

        .header-logo {
            text-align: center;
            margin-bottom: 25px;
        }

        .header-logo h2 {
            color: var(--primary);
            font-size: 28px;
            margin: 0;
            font-weight: 800;
        }

        .search-group { margin-bottom: 20px; position: relative; }
        
        label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            font-size: 14px;
            color: var(--primary); 
        }

        input, select { 
            width: 100%; 
            padding: 14px; 
            border: 2px solid #edf2f7; 
            border-radius: 10px; 
            box-sizing: border-box; 
            font-size: 16px; 
            transition: border-color 0.3s ease;
        }

        input:focus { border-color: var(--primary); outline: none; }

        button { 
            width: 100%; 
            padding: 16px; 
            background: var(--accent); 
            color: white; 
            border: none; 
            border-radius: 10px; 
            font-size: 17px; 
            cursor: pointer; 
            font-weight: bold; 
            transition: transform 0.1s, background 0.3s;
        }

        button:active { transform: scale(0.98); }
        button:disabled { background: #ccc; cursor: not-allowed; }

        /* Suggestions G√©o */
        #geoSuggestions { 
            position: absolute; 
            width: 100%; 
            background: white; 
            border: 1px solid #edf2f7; 
            z-index: 1000; 
            border-radius: 0 0 10px 10px; 
            display: none; 
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
        }

        .geo-item { 
            padding: 14px; 
            cursor: pointer; 
            border-bottom: 1px solid #f7fafc; 
            font-size: 15px;
        }

        .geo-item:hover { background: #f8faff; color: var(--primary); }

        /* Cartes R√©sultats */
        .company-card { 
            border: 1px solid #edf2f7; 
            padding: 18px; 
            margin-top: 12px; 
            border-radius: 12px; 
            background: #fff; 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            transition: box-shadow 0.2s;
        }

        .company-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.05); }

        /* Bottom Sheet UI */
        #detailsSheet { 
            position: fixed; left: 0; right: 0; bottom: -100%; 
            height: auto; min-height: 380px;
            background: white; 
            box-shadow: 0 -10px 30px rgba(0,0,0,0.15); 
            border-radius: 25px 25px 0 0; 
            transition: bottom 0.4s cubic-bezier(0.25, 1, 0.5, 1); 
            z-index: 2000; padding: 25px; 
            box-sizing: border-box; 
        }

        #detailsSheet.open { bottom: 0 !important; }
        
        .overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.4); display: none; z-index: 1500; 
            backdrop-filter: blur(2px);
        }

        .handle { width: 50px; height: 6px; background: #e2e8f0; border-radius: 10px; margin: 0 auto 20px; }
        
        .loader { text-align: center; padding: 20px; color: var(--primary); font-weight: 500; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-logo">
        <h2>Hub Emploi</h2>
    </div>

    <div class="search-group">
        <label for="jobInput">M√©tier recherch√©</label>
        <input type="text" id="jobInput" placeholder="Ex: Boulanger, D√©veloppeur..." aria-label="M√©tier">
    </div>

    <div class="search-group">
        <label for="geoInput">O√π ? (Ville ou d√©partement)</label>
        <input type="text" id="geoInput" placeholder="Saisissez une ville..." autocomplete="off">
        <div id="geoSuggestions" role="listbox"></div>
    </div>

    <div class="search-group">
        <label for="ageSelect">Tranche d'√¢ge</label>
        <select id="ageSelect">
            <option value="Non pr√©cis√©">Choisir une option...</option>
            <option value="18-25">Jeune (18-25 ans)</option>
            <option value="26-45">Adulte (26-45 ans)</option>
            <option value="45+">Senior (45 ans et +)</option>
        </select>
    </div>

    <button id="searchBtn" onclick="lancerRecherche()">Rechercher les entreprises</button>

    <div id="results"></div>
</div>

<div class="overlay" id="overlay" onclick="fermerDetails()"></div>

<div id="detailsSheet">
    <div class="handle"></div>
    <h3 id="sheetTitle" style="color:var(--primary); margin: 0 0 10px 0; font-size: 22px;"></h3>
    <p id="sheetAddress" style="color:#718096; font-size: 16px; margin-bottom: 25px;"></p>
    
    <button id="btnContact" style="background:var(--primary); margin-bottom: 12px;">üìë Consulter la fiche M√©tierscope</button>
    <button style="background:transparent; color:#718096; border: 2px solid #e2e8f0;" onclick="fermerDetails()">Fermer</button>
</div>

<script>
    let selectedGeo = { label: '', type: 'commune' };

    // S√©curit√© : Nettoyage des cha√Ænes de caract√®res (XSS)
    function sanitize(str) {
        if (!str) return "";
        const temp = document.createElement('div');
        temp.textContent = str;
        return temp.innerHTML;
    }

    // Gestion de l'autocompl√©tion g√©o
    const geoInput = document.getElementById('geoInput');
    const geoSuggestions = document.getElementById('geoSuggestions');

    geoInput.addEventListener('input', debounce(async (e) => {
        const query = e.target.value.trim();
        if (query.length < 3) {
            geoSuggestions.style.display = 'none';
            return;
        }

        try {
            const res = await fetch(`/api/suggestions?q=${encodeURIComponent(query)}`);
            const data = await res.json();
            
            if (data.length > 0) {
                geoSuggestions.innerHTML = data.map(item => `
                    <div class="geo-item" onclick="selectionnerG√©o('${sanitize(item.label)}', '${item.type}')">
                        ${sanitize(item.label)}
                    </div>`).join('');
                geoSuggestions.style.display = 'block';
            } else {
                geoSuggestions.style.display = 'none';
            }
        } catch (err) { console.error("API G√©o indisponible"); }
    }, 300));

    function selectionnerG√©o(label, type) {
        geoInput.value = label;
        selectedGeo = { label, type };
        geoSuggestions.style.display = 'none';
    }

    async function lancerRecherche() {
        const btn = document.getElementById('searchBtn');
        const job = document.getElementById('jobInput').value.trim();
        const geo = geoInput.value.trim();
        const age = document.getElementById('ageSelect').value;

        if (!job || !geo) {
            return alert("Veuillez renseigner un m√©tier et une localisation.");
        }

        btn.disabled = true;
        btn.innerHTML = 'üîç Recherche...';
        document.getElementById('results').innerHTML = '<div class="loader">Analyse des opportunit√©s en cours...</div>';

        try {
            // Appel √† l'endpoint de recherche du serveur explorer.js
            const url = `/api/search?metier=${encodeURIComponent(job)}&ville=${encodeURIComponent(geo)}&age=${encodeURIComponent(age)}`;
            const res = await fetch(url);
            const results = await res.json();

            if (!results.length) {
                document.getElementById('results').innerHTML = '<p style="text-align:center; padding:20px;">Aucune entreprise trouv√©e pour ces crit√®res.</p>';
            } else {
                document.getElementById('results').innerHTML = results.map(r => `
                    <div class="company-card" onclick="ouvrirD√©tails('${sanitize(r.name)}', '${sanitize(r.city)}', '${sanitize(r.link)}')">
                        <div>
                            <strong>üè¢ ${sanitize(r.name)}</strong><br>
                            <small>üìç ${sanitize(r.city)}</small>
                        </div>
                        <div style="color:var(--accent); font-weight:bold;">‚ûî</div>
                    </div>`).join('');
            }
        } catch (err) {
            document.getElementById('results').innerHTML = '<p style="color:var(--accent); text-align:center;">Erreur de connexion au serveur.</p>';
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'Rechercher les entreprises';
        }
    }

    function ouvrirD√©tails(nom, ville, lien) {
        document.getElementById('sheetTitle').innerText = nom;
        document.getElementById('sheetAddress').innerText = "Localisation : " + ville;
        const btn = document.getElementById('btnContact');
        
        btn.onclick = () => window.open(lien, '_blank');
        btn.style.display = (lien && lien.startsWith('http')) ? 'block' : 'none';

        document.getElementById('detailsSheet').classList.add('open');
        document.getElementById('overlay').style.display = 'block';
    }

    function fermerDetails() {
        document.getElementById('detailsSheet').classList.remove('open');
        document.getElementById('overlay').style.display = 'none';
    }

    // Utilitaire : Limite les appels API pendant la frappe
    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    // Fermeture des suggestions si clic ailleurs
    document.addEventListener('click', (e) => {
        if (!geoInput.contains(e.target)) geoSuggestions.style.display = 'none';
    });
</script>

</body>
</html>