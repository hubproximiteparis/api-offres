<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hub Proximité | Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #1a365d; --accent: #d9534f; --bg: #fdfcfb; --lbb: #3182ce; }
        body { background: var(--bg); font-family: 'Inter', sans-serif; margin: 0; padding-bottom: 100px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 450px; padding: 20px; box-sizing: border-box; }
        @media (min-width: 768px) { .container { max-width: 700px; } }
        .header { text-align: center; margin-bottom: 20px; }
        .search-box { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; position: relative; }
        .search-input-group { display: flex; gap: 8px; margin-bottom: 10px; position: relative; }
        input { border: 1px solid #edf2f7; padding: 12px; border-radius: 10px; font-weight: 600; outline: none; width: 100%; box-sizing: border-box; }
        .suggestions-list { display: none; position: absolute; top: 55px; left: 0; width: 100%; background: white; border: 1px solid #e2e8f0; border-radius: 12px; box-shadow: 0 10px 15px rgba(0,0,0,0.1); z-index: 1000; max-height: 200px; overflow-y: auto; }
        .suggestion-item { padding: 10px 15px; cursor: pointer; font-size: 13px; border-bottom: 1px solid #f7fafc; font-weight: 500; }
        .suggestion-item:hover { background: #f8fafc; color: var(--accent); }
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 12px; border-radius: 10px; border: 1px solid #edf2f7; background: white; font-size: 11px; font-weight: 800; cursor: pointer; color: #a0aec0; text-transform: uppercase; }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .results-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        @media (min-width: 768px) { .results-grid { grid-template-columns: 1fr 1fr; } }
        .job-card { background: white; padding: 15px; border-radius: 12px; border-left: 4px solid var(--accent); box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .card-lbb { border-left-color: var(--lbb); }
        .job-card h3 { margin: 0 0 8px 0; font-size: 14px; color: var(--primary); font-weight: 800; line-height: 1.2; }
        .job-card .meta { font-size: 11px; color: #718096; margin-bottom: 8px; font-weight: 600; }
        .job-card .description { font-size: 12px; color: #4a5568; margin-bottom: 12px; display: -webkit-box; -webkit-line-clamp: 3; line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .btn-view { align-self: flex-start; background: #f7fafc; padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 700; color: var(--primary); text-decoration: none; border: 1px solid #edf2f7; }
        .btn-main { width: 100%; background: var(--primary); color: white; border: none; padding: 16px; border-radius: 12px; font-weight: 800; cursor: pointer; transition: 0.3s; font-size: 14px; }
        .btn-main:disabled { background: #cbd5e0; }
        .section-title { font-size: 11px; font-weight: 800; color: #a0aec0; text-transform: uppercase; margin: 25px 0 12px; border-bottom: 1px solid #edf2f7; padding-bottom: 5px; }
        .grid-apps { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .app-item { border: none; background: none; display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 0; }
        .app-icon { width: 50px; height: 50px; border-radius: 14px; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; margin-bottom: 6px; }
        .app-label { font-size: 9px; font-weight: 700; color: var(--primary); text-align: center; }
        .bg-blue { background: #3182ce; } .bg-green { background: #38a169; } .bg-orange { background: #dd6b20; }
        .bg-red { background: #e53e3e; } .bg-purple { background: #805ad5; } .bg-cyan { background: #00b5ad; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2 style="color:var(--primary); margin:0; letter-spacing: -1px;">HUB PROXIMITÉ</h2>
        <small style="color:#a0aec0; font-weight: 600;">Moteur de Recherche Supabase v2</small>
    </div>

    <div class="search-box">
        <div class="search-input-group">
            <div style="flex:2; position:relative;">
                <input type="text" id="jobSearch" placeholder="Métier (ex: Boulanger)" autocomplete="off">
                <div id="jobSuggestions" class="suggestions-list"></div>
            </div>
            <input type="text" id="zipCode" placeholder="Code INSEE" value="75101" style="flex:1; text-align:center">
        </div>
        <button onclick="runMainScan()" id="scanBtn" class="btn-main">LANCER LA RECHERCHE</button>
    </div>

    <div id="resultsSection" style="display:none;">
        <div class="tabs">
            <button onclick="switchTab('offres')" id="tabOffres" class="tab-btn active">Offres Directes</button>
            <button onclick="switchTab('services')" id="tabServices" class="tab-btn">Marché Caché</button>
        </div>
        <div id="paneOffres"><div id="resultsList" class="results-grid"></div></div>
        <div id="paneServices" style="display:none;"><div id="companiesList" class="results-grid"></div></div>
    </div>

    <div id="defaultApps">
        <div class="section-title">Emploi & Formation</div>
        <div class="grid-apps">
            <div class="app-item" onclick="window.open('https://www.apec.fr')"><div class="app-icon bg-purple"><i class="fas fa-user-tie"></i></div><div class="app-label">APEC</div></div>
            <div class="app-item" onclick="window.open('https://www.moncompteformation.gouv.fr')"><div class="app-icon bg-green"><i class="fas fa-piggy-bank"></i></div><div class="app-label">Mon CPF</div></div>
            <div class="app-item" onclick="window.open('https://www.ameli.fr')"><div class="app-icon bg-blue"><i class="fas fa-heartbeat"></i></div><div class="app-label">Ameli</div></div>
            <div class="app-item" onclick="window.open('https://www.caf.fr')"><div class="app-icon bg-cyan"><i class="fas fa-house-user"></i></div><div class="app-label">CAF</div></div>
        </div>
    </div>
</div>

<script>
    const SUPABASE_URL = "https://oambnmyooilnilycxkwv.supabase.co/functions/v1/market-data";
    const ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9hbWJubXlvb2lsbmlseWN4a3d2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczMzkyMDMsImV4cCI6MjA4MjkxNTIwM30.TWFUy_SkpLoF9ndg7KaGSvWs0YePh77AlLThnpCrDIg";

    const jobSearch = document.getElementById('jobSearch');
    const jobSuggestions = document.getElementById('jobSuggestions');
    let selectedRome = "";

    // CORRECTION : Recherche ROME via Supabase au lieu de localhost
    jobSearch.addEventListener('input', async () => {
    const query = jobSearch.value.trim();
    if (query.length < 3) { 
        jobSuggestions.style.display = 'none'; 
        return; 
    }
    
    try {
        const res = await fetch(SUPABASE_URL, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json', 
                'Authorization': `Bearer ${ANON_KEY}` 
            },
            body: JSON.stringify({ action: "search-rome", query: query })
        });
        const data = await res.json();
        
        // On s'assure que data est bien un tableau
        const suggestions = Array.isArray(data) ? data : (data.resultats || []);

        if (suggestions.length > 0) {
            jobSuggestions.innerHTML = suggestions.map(m => `
                <div class="suggestion-item" onclick="selectJob('${m.libelle.replace(/'/g, "\\'")}', '${m.code}')">
                    ${m.libelle} <span style="color:#cbd5e0; font-size:10px;">(${m.code})</span>
                </div>
            `).join('');
            jobSuggestions.style.display = 'block'; // Force l'apparition
        } else {
            jobSuggestions.style.display = 'none';
        }
    } catch(e) { 
        console.error("Erreur Suggestions:", e);
        jobSuggestions.style.display = 'none';
    }
});
    function selectJob(libelle, code) {
        jobSearch.value = libelle;
        selectedRome = code;
        jobSuggestions.style.display = 'none';
    }

    async function runMainScan() {
    const btn = document.getElementById('scanBtn');
    const cp = document.getElementById('zipCode').value;
    const rawInput = jobSearch.value.trim();
    
    if(!rawInput) return alert("Indiquez un métier");

    btn.disabled = true;
    btn.innerText = "SCAN 360° EN COURS...";
    document.getElementById('resultsSection').style.display = 'block';
    document.getElementById('resultsList').innerHTML = "Chargement...";
    document.getElementById('companiesList').innerHTML = "Chargement...";

    try {
        // 1. Appel des Offres Directes (fonctionne toujours avec le texte)
        const resOffres = await fetch(SUPABASE_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
            body: JSON.stringify({ action: "get-offres", metier: rawInput, code_postal: cp })
        });
        const offres = await resOffres.json();
        displayOffres(offres, cp);

        // 2. Récupération automatique du code ROME si absent
        let queryRome = selectedRome;
        if (!queryRome) {
            const resRome = await fetch(SUPABASE_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
                body: JSON.stringify({ action: "search-rome", query: rawInput })
            });
            const romeData = await resRome.json();
            if (Array.isArray(romeData) && romeData.length > 0) {
                queryRome = romeData[0].code; // On prend le premier résultat par défaut
            }
        }

        // 3. Appel LBB (Marché Caché)
        if (queryRome) {
            const resLBB = await fetch(SUPABASE_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
                body: JSON.stringify({ action: "get-lbb", metier: queryRome, code_postal: cp })
            });
            const entreprises = await resLBB.json();
            displayLBB(entreprises, cp);
        } else {
            document.getElementById('companiesList').innerHTML = "<div class='small-text' style='color:#e53e3e; padding:15px; background:#fff5f5; border-radius:10px;'>Métier non reconnu pour le Marché Caché. Essayez une autre appellation.</div>";
        }

    } catch (e) {
        console.error("Erreur Scan:", e);
    } finally {
        btn.disabled = false;
        btn.innerText = "LANCER LA RECHERCHE";
        }
    }

    function displayOffres(data, cp) {
        const list = document.getElementById('resultsList');
        if (!Array.isArray(data) || data.length === 0) {
            list.innerHTML = "<div class='small-text'>Aucune offre trouvée à proximité.</div>";
            return;
        }
        list.innerHTML = data.map(off => `
            <div class="job-card">
                <div class="meta">${off.typeContratLibelle || 'Contrat'} • ${off.lieuTravail?.libelle || cp}</div>
                <h3>${off.intitule}</h3>
                <div class="description">${off.description || ''}</div>
                <a href="${off.origineOffre?.urlOrigine}" target="_blank" class="btn-view">VOIR L'OFFRE</a>
            </div>
        `).join('');
    }

    function displayLBB(data, cp) {
    const list = document.getElementById('companiesList');
    if (!Array.isArray(data) || data.length === 0) {
        list.innerHTML = "<div class='small-text'>Aucune entreprise trouvée pour ce métier dans ce secteur.</div>";
        return;
    }

    list.innerHTML = data.map(ent => {
        // Génération visuelle des étoiles
        const starCount = Math.round(ent.stars || 0);
        const starsHtml = '⭐'.repeat(starCount) || 'N/A';

        return `
            <div class="job-card card-lbb">
                <div class="meta" style="color: #3182ce;">
                    Potentiel d'embauche : ${starsHtml}
                </div>
                <h3>${ent.name}</h3>
                <div class="meta"><i class="fas fa-map-marker-alt"></i> ${ent.city || cp}</div>
                <div class="description">Cette entreprise recrute souvent dans ce secteur d'activité mais n'a pas forcément publié d'offre.</div>
                <a href="https://www.google.com/search?q=${encodeURIComponent(ent.name)}+${cp}+recrutement" 
                   target="_blank" class="btn-view" style="border-color: #3182ce; color: #3182ce;">
                   CANDIDATURE SPONTANÉE
                </a>
            </div>
        `;
    }).join('');
    }

    function switchTab(type) {
        const isOffres = type === 'offres';
        document.getElementById('paneOffres').style.display = isOffres ? 'block' : 'none';
        document.getElementById('paneServices').style.display = isOffres ? 'none' : 'block';
        document.getElementById('tabOffres').classList.toggle('active', isOffres);
        document.getElementById('tabServices').classList.toggle('active', !isOffres);
    }

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.search-input-group')) jobSuggestions.style.display = 'none';
    });
</script>
</body>
</html>