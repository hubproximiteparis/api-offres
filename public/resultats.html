<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Résultats | Hub Proximité</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { 
            --primary: #1a365d; 
            --accent: #d9534f; 
            --bg-warm: linear-gradient(135deg, #fdfcfb 0%, #e2d1c3 100%);
        }
        
        body { background: var(--bg-warm); background-attachment: fixed; font-family: 'Inter', sans-serif; margin: 0; padding-bottom: 120px; min-height: 100vh; }
        
        .header { 
            background: white; padding: 15px 20px; position: sticky; top: 0; z-index: 100; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 15px; 
        }
        
        .back-btn { border: none; background: #f7fafc; width: 40px; height: 40px; border-radius: 12px; color: var(--primary); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: 0.2s; }
        .back-btn:active { transform: scale(0.9); background: #edf2f7; }

        .results-container { padding: 20px; max-width: 500px; margin: 0 auto; }
        
        .card { 
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
            border-radius: 20px; padding: 20px; margin-bottom: 15px; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.05); position: relative; 
            border: 1px solid rgba(255,255,255,0.3); transition: transform 0.2s;
        }
        
        .card h3 { margin: 0 0 10px 0; font-size: 15px; color: var(--primary); padding-right: 35px; line-height: 1.4; font-weight: 800; }
        
        .info-tag { font-size: 12px; color: #718096; margin-bottom: 6px; display: flex; align-items: center; gap: 8px; font-weight: 600; }
        .info-tag i { color: #cbd5e0; width: 14px; }

        .btn-apply { 
            display: flex; align-items: center; justify-content: center; gap: 8px;
            width: 100%; background: var(--primary); color: white; padding: 14px; 
            border-radius: 14px; text-decoration: none; font-weight: 800; font-size: 13px; 
            margin-top: 15px; transition: 0.2s; text-transform: uppercase;
        }
        .btn-apply:active { transform: scale(0.98); opacity: 0.9; }
        
        .fav-btn { 
            position: absolute; top: 15px; right: 15px; background: white; border: 1px solid #edf2f7; 
            color: #cbd5e0; width: 36px; height: 36px; border-radius: 10px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; font-size: 18px; transition: 0.3s; 
        }
        .fav-btn.active { color: var(--accent); border-color: #fed7d7; background: #fff5f5; }
        
        .loader { text-align: center; padding: 60px 20px; color: var(--primary); font-weight: 700; }
        .error-msg { text-align: center; padding: 40px; background: white; border-radius: 20px; color: #718096; font-size: 14px; }

        /* Nav Basse */
        .bottom-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: white; display: flex; justify-content: space-around; padding: 12px 0; border-radius: 35px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); z-index: 1000; }
        .nav-link { text-decoration: none; color: #cbd5e0; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
        .nav-link.active { color: var(--primary); }
        #fav-badge { position: absolute; top: -8px; right: -8px; background: var(--accent); color: white; font-size: 9px; padding: 2px 5px; border-radius: 10px; border: 2px solid white; font-weight: 800; }
    </style>
</head>
<body>

<div class="header">
    <button class="back-btn" onclick="window.location.href='recherche-experte.html'"><i class="fas fa-arrow-left"></i></button>
    <div style="overflow: hidden;">
        <h2 id="metierTitle" style="margin:0; font-size: 16px; color: var(--primary); font-weight: 800; white-space: nowrap; text-overflow: ellipsis;">Résultats</h2>
        <small id="villeLabel" style="color: #a0aec0; font-weight: 700; text-transform: uppercase; font-size: 10px; letter-spacing: 0.5px;">Scanner en cours...</small>
    </div>
</div>

<div id="results-container" class="results-container">
    <div class="loader">
        <i class="fas fa-circle-notch fa-spin fa-3x" style="margin-bottom: 15px; color: var(--accent);"></i>
        <p>Analyse du marché en temps réel...</p>
    </div>
</div>

<nav class="bottom-nav">
    <a href="index.html" class="nav-link"><i class="fas fa-th-large"></i><span>Hub</span></a>
    <a href="recherche-experte.html" class="nav-link active"><i class="fas fa-search"></i><span>Scanner</span></a>
    <a href="favoris.html" class="nav-link">
        <div style="position: relative;">
            <i class="far fa-bookmark" id="fav-icon"></i>
            <span id="fav-badge" style="display: none;">0</span>
        </div>
        <span>Favoris</span>
    </a>
</nav>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const supabaseClient = supabase.createClient(
    'https://oambnmyooilnilycxkwv.supabase.co', 
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9hbWJubXlvb2lsbmlseWN4a3d2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczMzkyMDMsImV4cCI6MjA4MjkxNTIwM30.TWFUy_SkpLoF9ndg7KaGSvWs0YePh77AlLThnpCrDIg'
);

const params = new URLSearchParams(window.location.search);
const metier = params.get('metier');
const ville = params.get('ville');
const labelVille = params.get('label') || 'Secteur sélectionné';

// 1. Mise à jour du badge Favoris
function updateFavBadge() {
    const favoris = JSON.parse(localStorage.getItem('hub_favoris') || '[]');
    const badge = document.getElementById('fav-badge');
    const icon = document.getElementById('fav-icon');
    
    if (favoris.length > 0) {
        badge.innerText = favoris.length;
        badge.style.display = 'block';
        if(icon) icon.classList.replace('far', 'fas');
    } else {
        badge.style.display = 'none';
        if(icon) icon.classList.replace('fas', 'far');
    }
}

// 2. Appel à la fonction Edge Supabase
async function fetchResults() {
    const container = document.getElementById('results-container');
    document.getElementById('metierTitle').innerText = metier || "Résultats";
    document.getElementById('villeLabel').innerText = labelVille;

    try {
        const { data, error } = await supabaseClient.functions.invoke('market-data', {
            body: { action: 'get-offres', metier: metier, code_postal: ville }
        });

        if (error) throw error;
        
        if (!data || data.length === 0) {
            container.innerHTML = `
                <div class="error-msg">
                    <i class="fas fa-search-minus fa-2x" style="display:block; margin-bottom:10px;"></i>
                    Aucune offre trouvée pour "<strong>${metier}</strong>" à ${labelVille}.
                </div>`;
            return;
        }
        renderCards(data);
    } catch (err) {
        console.error("Erreur:", err);
        container.innerHTML = `<div class="error-msg">⚠️ Erreur de connexion. Veuillez vérifier votre accès internet.</div>`;
    }
}

// 3. Affichage des cartes avec gestion du tracking
function renderCards(offres) {
    const container = document.getElementById('results-container');
    const favoris = JSON.parse(localStorage.getItem('hub_favoris') || '[]');

    container.innerHTML = offres.map(offre => {
        const isFav = favoris.some(f => f.id === offre.id);
        
        // Configuration du lien de redirection (Tracking)
        const originalUrl = offre.url || offre.urlOrigine || "#";
        const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:3050' : 'https://hub-proximite.onrender.com';
        const trackingUrl = `${API_BASE}/api/redirect?url=${encodeURIComponent(originalUrl)}&tool=scanner&metier=${encodeURIComponent(offre.intitule)}`;

        return `
            <div class="card">
                <button class="fav-btn ${isFav ? 'active' : ''}" 
                        id="btn-${offre.id}" 
                        onclick="toggleFavori('${offre.id}', '${btoa(unescape(encodeURIComponent(JSON.stringify(offre))))}')">
                    <i class="${isFav ? 'fas' : 'far'} fa-bookmark"></i>
                </button>
                <h3>${offre.intitule}</h3>
                <div class="info-tag">
                    <i class="fas fa-building"></i> ${offre.entreprise?.nom || 'Employeur Confidentiel'}
                </div>
                <div class="info-tag">
                    <i class="fas fa-map-marker-alt"></i> ${offre.lieuTravail?.libelle || labelVille}
                </div>
                <div class="info-tag">
                    <i class="fas fa-file-contract"></i> ${offre.typeContratLibelle || offre.typeContrat || 'Contrat non précisé'}
                </div>
                <a href="${trackingUrl}" target="_blank" class="btn-apply">
                   Consulter l'offre <i class="fas fa-external-link-alt" style="font-size:11px;"></i>
                </a>
            </div>
        `;
    }).join('');
}

// 4. Gestion des favoris (Sans rechargement de page)
window.toggleFavori = (id, dataB64) => {
    let favoris = JSON.parse(localStorage.getItem('hub_favoris') || '[]');
    const btn = document.getElementById(`btn-${id}`);
    const index = favoris.findIndex(f => f.id === id);

    if (index > -1) {
        favoris.splice(index, 1);
        btn.classList.remove('active');
        btn.querySelector('i').classList.replace('fas', 'far');
    } else {
        const offreData = JSON.parse(decodeURIComponent(escape(atob(dataB64))));
        favoris.push(offreData);
        btn.classList.add('active');
        btn.querySelector('i').classList.replace('far', 'fas');
    }

    localStorage.setItem('hub_favoris', JSON.stringify(favoris));
    updateFavBadge();
};

// Initialisation au chargement
document.addEventListener('DOMContentLoaded', () => {
    fetchResults();
    updateFavBadge();
});
</script>
</body>
</html>